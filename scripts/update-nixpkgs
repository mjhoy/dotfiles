#!/bin/bash
#
# This script does the following:
#
# 1. Updates `nixpkgs` reference using `niv`
# 2. Commits changes and opens a github PR

set -eou pipefail

if [ -n "$(git status --porcelain)" ]; then
    echo "git status dirty; exiting";
    exit 1
fi

DATE=$(date "+%Y-%m-%d")

BRANCH_NAME=update-nixpkgs-$DATE

git checkout -b $BRANCH_NAME

niv update nixpkgs

git add nix/sources.json

git commit -m "update nixpkgs $DATE"

git push origin $BRANCH_NAME -u

gh pr create --title "update nixpkgs $DATE" --body "generated by scripts/update-nixpkgs"
