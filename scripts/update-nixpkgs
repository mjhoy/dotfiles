#!/bin/bash
#
# This script does the following:
#
# 1. Updates `nixpkgs` reference using `niv`
# 2. Updates the commit referenced in nix/nixpkgs/overlays.nix
# 3. Commits changes and opens a github PR

set -eou pipefail

if [ -n "$(git status --porcelain)" ]; then
    echo "git status dirty; exiting";
    exit 1
fi

DATE=$(date "+%Y-%m-%d")

BRANCH_NAME=update-nixpkgs-$DATE

git checkout -b $BRANCH_NAME

niv update nixpkgs

git add nix/sources.json

git commit -m "update nixpkgs $DATE"

LATEST_EMACS_REF=$(gh api /repos/nix-community/emacs-overlay/git/ref/heads/master | jq -r '.object.sha')

sed -i '' -e "s|emacs-overlay/archive/.*|emacs-overlay/archive/$LATEST_EMACS_REF.tar.gz;|g" nix/nixpkgs/overlays.nix

git add nix/nixpkgs/overlays.nix

git commit -m "update emacs overlay $DATE"

git push origin $BRANCH_NAME -u

gh pr create --title "update nixpkgs $DATE" --body "generated by scripts/update-nixpkgs"
